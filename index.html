<!DOCTYPE html>
<html lang="ta">
<head>
  <meta charset="UTF-8" />
  <title>ро╡ро┐роорпНроЪрпЛродрпНродро░ро┐ родроЪрпИ рооро▒рпНро▒рпБроорпН 108 рокро╛родроЩрпНроХро│рпН ро░ро╛роЪро┐ роХроЯрпНроЯроорпН</title>
  <style>
    body {
      font-family: 'Latha', Arial, sans-serif;
      background: #fffef8;
      text-align: center;
      padding: 18px;
      margin: 0;
    }

    .south-chart {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-areas:
        "r10  r11  r12  r01"
        "r09  xx   xx   r02"
        "r08  xx   xx   r03"
        "r07  r06  r05  r04";
      gap: 5px;
      max-width: 940px;
      margin: 0 auto 22px;
    }

    .box {
      background: #fffdf5;
      border: 2px solid #ce0808;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(100, 85, 50, 0.1);
      font-size: 12.5px;
      color: #4b1d1d;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      align-items: left;
      text-align: left;
      justify-content: left;
      padding: 6px 2px;
      height: 275px;
    }
    
    .box:hover {
      transform: scale(1.015);
      background: #fff5e6;
    }

    .rasi-name {
      font-weight: bold;
      font-size: 15.5px;
      color: #872b0c;
      margin-bottom: 4px;
      text-align: center;
    }

    .line {
      cursor: pointer;
      width: 100%;
      border-radius: 4px;
      padding: 3px 2px;
      margin-bottom: 1.5px;
      line-height: 1.5;
      transition: background 0.3s;
    }

    .line:hover {
      background: #e9f0f9;
    }

    .highlight-dasa {
      background: #1d60b2 !important;
      color: #fff;
      font-weight: bold;
    }

    .highlight-puthi {
      background: #62a0ff !important;
      color: #003f75;
    }

    .highlight-anth {
      background: #d6ebff !important;
      color: #134766;
    }

    .currentbox {
      margin: 16px auto 24px auto;
      background: #e8ecf7;
      border-radius: 10px;
      box-shadow: 0 2px 6px #87aed9aa;
      padding: 16px 26px;
      font-size: 1.1em;
      text-align: left;
      max-width: 670px;
    }

    .treeul {
      list-style: none;
      padding-left: 26px;
      text-align: left;
      max-width: 470px;
      margin: 0 auto;
    }

    .headli {
      font-weight: bold;
      margin: 4px 0;
    }

    .current-dasa {
      background: #1d60b2 !important;
      color: #fff;
    }

    .current-puthi {
      background: #62a0ff !important;
      color: #003f75;
    }

    .current-anthara {
      background: #d6ebff !important;
      color: #134766;
    }

    .dates {
      color: #555;
      font-size: 90%;
      margin-left: 8px;
    }

    .pada {
      color: #19733c;
    }

    .padasplit {
      margin: 20px auto 20px auto;
      background: #f4faff;
      border-radius: 7px;
      padding: 12px;
      max-width: 470px;
      box-shadow: 0 1px 3px #ccc;
      font-size: 1em;
      text-align: left;
    }

    .padasplit u {
      font-weight: bold;
      color: #444;
    }

    .expcol {
      cursor: pointer;
      padding: 2px 6px;
      background: #ddd;
      border-radius: 3px;
      font-size: 93%;
      margin-left: 7px;
      color: #075;
      user-select: none;
    }

    .expcol.open {
      background: #bbdefb;
    }

    .expcol:hover {
      text-decoration: underline;
    }

    button[type=submit] {
      background: #2f76d2;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 1.5px 4px rgba(0, 0, 0, 0.1);
      transition: background 0.2s ease;
    }

    button[type=submit]:hover {
      background: #195ea8;
    }

    .r01 { grid-area: r11; }
    .r02 { grid-area: r12; }
    .r03 { grid-area: r01; }
    .r04 { grid-area: r02; }
    .r05 { grid-area: r03; }
    .r06 { grid-area: r04; }
    .r07 { grid-area: r05; }
    .r08 { grid-area: r06; }
    .r09 { grid-area: r07; }
    .r10 { grid-area: r08; }
    .r11 { grid-area: r09; }
    .r12 { grid-area: r10; }

    @media (max-width: 900px) {
      .box {
        height: auto;
      }
      .south-chart {
        grid-template-columns: repeat(2, 1fr);
        grid-template-areas:
          "r01 r02"
          "r03 r04"
          "r05 r06"
          "r07 r08"
          "r09 r10"
          "r11 r12";
      }
      .currentbox,
      .padasplit {
        margin: 10px auto;
        font-size: 95%;
      }
    }
    #main-container {
  display: grid;
  grid-template-columns: 30% 70%;
  column-gap: 20px;
  max-width: 1200px; /* adjust as desired */
  margin: 0 auto 40px auto; /* centered horizontally with spacing below */
  align-items: start; /* align content at top */
}

#left-column, #right-column {
  background: #fefefe;
  border: 1.5px solid #ccc;
  border-radius: 10px;
  padding: 16px;
  box-shadow: 0 2px 6px #ccc9;
  overflow-y: auto;
  max-height: 800px; /* optional: fixed max height with vertical scroll */
}

#current {
  margin-bottom: 24px; /* spacing between current and padasplit */
}

  </style>
</head>
<body>
  <h2>ЁЯМЯ родрпЖройрпН роЗроирпНродро┐роп ро░ро╛роЪро┐ роХроЯрпНроЯроорпН (108 рокро╛родроЩрпНроХро│рпН) + <span style="color:#175397;">ро╡ро┐роорпНроЪрпЛродрпНродро░ро┐ родроЪрпИ</span> ЁЯМЯ</h2>

  <div class="south-chart" id="rasiChart"></div>

  <form onsubmit="event.preventDefault(); run();">
    <div style="margin-bottom:6px;">
      <label>рокро┐ро▒роирпНрод родрпЗродро┐: <input type="date" id="dob" required></label>
      <span class="moonbox" style="margin-left:8px;">
        роЪроирпНродро┐ро░ройрпН Degree : <input type="number" id="moon_deg" min="0" max="359" step="1" required style="width:38px;">┬░
        <input type="number" id="moon_min" min="0" max="59"  step="1" required style="width:38px;">'
        <input type="number" id="moon_sec" min="0" max="59"  step="1" required style="width:38px;">"
      </span>
    </div>
    <div style="margin-bottom: 6px;">
      <label>роХрогро┐рокрпНрокрпБроХрпНроХро╛рой родрпЗродро┐: <input type="datetime-local" id="caldate" style="width:210px;"></label>
    </div>
    <button type="submit" style="margin-left:0;">роХрогроХрпНроХро┐роЯрпБ</button>
  </form>
  <div id="main-container">
  <div id="left-column">
    <div id="dasatree"></div>
  </div>
  <div id="right-column">
    <div id="current"></div>
    <div id="padasplit"></div>
  </div>
</div>

  
  

  <script>
    /* ---------- Chart with all padas always visible ---------- */
    const rasiData = [
      { name: "роорпЗро╖роорпН", code: "r01", padas: ["роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 1", "роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 2", "роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 3", "роЕро╕рпНро╡ро┐ройро┐ - рокро╛родроорпН 4", "рокро░рогро┐ - рокро╛родроорпН 1", "рокро░рогро┐ - рокро╛родроорпН 2", "рокро░рогро┐ - рокро╛родроорпН 3", "рокро░рогро┐ - рокро╛родроорпН 4", "роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 1"] },
      { name: "ро░ро┐ро╖рокроорпН", code: "r02", padas: ["роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 2", "роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 3", "роХро┐ро░рпБродрпНродро┐роХрпИ - рокро╛родроорпН 4", "ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 1", "ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 2", "ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 3", "ро░рпЛро╣ро┐рогро┐ - рокро╛родроорпН 4", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 1", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 2"] },
      { name: "рооро┐родрпБройроорпН", code: "r03", padas: ["рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 3", "рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН - рокро╛родроорпН 4", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 1", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 2", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 3", "родро┐ро░рпБро╡ро╛родро┐ро░рпИ - рокро╛родроорпН 4", "рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 1", "рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 2", "рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 3"] },
      { name: "роХроЯроХроорпН", code: "r04", padas: ["рокрпБройро░рпНрокрпВроЪроорпН - рокро╛родроорпН 4", "рокрпВроЪроорпН - рокро╛родроорпН 1", "рокрпВроЪроорпН - рокро╛родроорпН 2", "рокрпВроЪроорпН - рокро╛родроорпН 3", "рокрпВроЪроорпН - рокро╛родроорпН 4", "роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 1", "роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 2", "роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 3", "роЖропро┐ро▓рпНропроорпН - рокро╛родроорпН 4"] },
      { name: "роЪро┐роорпНроороорпН", code: "r05", padas: ["роороХроорпН - рокро╛родроорпН 1", "роороХроорпН - рокро╛родроорпН 2", "роороХроорпН - рокро╛родроорпН 3", "роороХроорпН - рокро╛родроорпН 4", "рокрпВро░роорпН - рокро╛родроорпН 1", "рокрпВро░роорпН - рокро╛родроорпН 2", "рокрпВро░роорпН - рокро╛родроорпН 3", "рокрпВро░роорпН - рокро╛родроорпН 4", "роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 1"] },
      { name: "роХройрпНройро┐", code: "r06", padas: ["роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 2", "роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 3", "роЙродрпНродро┐ро░роорпН - рокро╛родроорпН 4", "ро╣ро╕рпНродроорпН - рокро╛родроорпН 1", "ро╣ро╕рпНродроорпН - рокро╛родроорпН 2", "ро╣ро╕рпНродроорпН - рокро╛родроорпН 3", "ро╣ро╕рпНродроорпН - рокро╛родроорпН 4", "роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 1", "роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 2"] },
      { name: "родрпБро▓ро╛роорпН", code: "r07", padas: ["роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 3", "роЪро┐родрпНродро┐ро░рпИ - рокро╛родроорпН 4", "роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 1", "роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 2", "роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 3", "роЪрпБро╡ро╛родро┐ - рокро╛родроорпН 4", "ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 1", "ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 2", "ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 3"] },
      { name: "ро╡ро┐ро░рпБроЪрпНроЪро┐роХроорпН", code: "r08", padas: ["ро╡ро┐роЪро╛роХроорпН - рокро╛родроорпН 4", "роЕройрпБро╖роорпН - рокро╛родроорпН 1", "роЕройрпБро╖роорпН - рокро╛родроорпН 2", "роЕройрпБро╖роорпН - рокро╛родроорпН 3", "роЕройрпБро╖роорпН - рокро╛родроорпН 4", "роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 1", "роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 2", "роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 3", "роХрпЗроЯрпНроЯрпИ - рокро╛родроорпН 4"] },
      { name: "родройрпБроЪрпБ", code: "r09", padas: ["роорпВро▓роорпН - рокро╛родроорпН 1", "роорпВро▓роорпН - рокро╛родроорпН 2", "роорпВро▓роорпН - рокро╛родроорпН 3", "роорпВро▓роорпН - рокро╛родроорпН 4", "рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 1", "рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 2", "рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 3", "рокрпВро░ро╛роЯроорпН - рокро╛родроорпН 4", "роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 1"] },
      { name: "роороХро░роорпН", code: "r10", padas: ["роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 2", "роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 3", "роЙродрпНродро┐ро░ро╛роЯроорпН - рокро╛родроорпН 4", "родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 1", "родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 2", "родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 3", "родро┐ро░рпБро╡рпЛрогроорпН - рокро╛родроорпН 4", "роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 1", "роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 2"] },
      { name: "роХрпБроорпНрокроорпН", code: "r11", padas: ["роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 3", "роЕро╡ро┐роЯрпНроЯроорпН - рокро╛родроорпН 4", "роЪродропроорпН - рокро╛родроорпН 1", "роЪродропроорпН - рокро╛родроорпН 2", "роЪродропроорпН - рокро╛родроорпН 3", "роЪродропроорпН - рокро╛родроорпН 4", "рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 1", "рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 2", "рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 3"] },
      { name: "роорпАройроорпН", code: "r12", padas: ["рокрпВро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 4", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 1", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 2", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 3", "роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐ - рокро╛родроорпН 4", "ро░рпЗро╡родро┐ - рокро╛родроорпН 1", "ро░рпЗро╡родро┐ - рокро╛родроорпН 2", "ро░рпЗро╡родро┐ - рокро╛родроорпН 3", "ро░рпЗро╡родро┐ - рокро╛родроорпН 4"] }
    ];
    let padaDomList = [];
    function drawChartGrid() {
      document.getElementById('rasiChart').innerHTML = '';
      padaDomList = [];
      let padaCounter = 1;
      rasiData.forEach((rasi, ri) => {
        const box = document.createElement("div");
        box.className = `box ${rasi.code}`;
        const title = document.createElement("div");
        title.className = "rasi-name";
        title.textContent = rasi.name;
        box.appendChild(title);
        for(let j=0; j<9; j++) {
          const line = document.createElement("div");
          line.className = "line";
          line.textContent = `${j + 1}. ${rasi.padas[j] ? rasi.padas[j] : "-"}`;
          line.setAttribute("data-pada-index", padaCounter);
          box.appendChild(line);
          padaDomList[padaCounter] = line;
          padaCounter++;
        }
        document.getElementById('rasiChart').appendChild(box);
      });
    }
    function highlightPada(padaLabel, cls) {
      // Remove previous highlights of this class
      document.querySelectorAll(`.line.${cls}`).forEach(e => e.classList.remove(cls));
      for(let i=1; i<=108; i++) {
        if(!padaDomList[i]) continue;
        let plabel = padaDomList[i].textContent.replace(/^[0-9]+\.\s*/, '').trim();
        if(plabel === padaLabel.trim()) {
          padaDomList[i].classList.add(cls);
        }
      }
    }
    function clearAllHighlights() {
      ['highlight-dasa','highlight-puthi','highlight-anth'].forEach(cls =>
        document.querySelectorAll(`.line.${cls}`).forEach(e => e.classList.remove(cls))
      );
    }

    const PLANETS = ["роХрпЗродрпБ","роЪрпБроХрпНро░ройрпН","роЪрпВро░ро┐ропройрпН","роЪроирпНродро┐ро░ройрпН","роЪрпЖро╡рпНро╡ро╛ропрпН","ро░ро╛роХрпБ","роХрпБро░рпБ","роЪройро┐","рокрпБродройрпН"];
    const DASA_YEARS = {"роХрпЗродрпБ":7,"роЪрпБроХрпНро░ройрпН":20,"роЪрпВро░ро┐ропройрпН":6,"роЪроирпНродро┐ро░ройрпН":10,"роЪрпЖро╡рпНро╡ро╛ропрпН":7,"ро░ро╛роХрпБ":18,"роХрпБро░рпБ":16,"роЪройро┐":19,"рокрпБродройрпН":17};
    const NAKS = [
      {name:'роЕро╕рпНро╡ро┐ройро┐',lord:'роХрпЗродрпБ'},
      {name:'рокро░рогро┐',lord:'роЪрпБроХрпНро░ройрпН'},
      {name:'роХро┐ро░рпБродрпНродро┐роХрпИ',lord:'роЪрпВро░ро┐ропройрпН'},
      {name:'ро░рпЛро╣ро┐рогро┐',lord:'роЪроирпНродро┐ро░ройрпН'},
      {name:'рооро┐ро░рпБроХроЪрпАро░ро┐роЯроорпН',lord:'роЪрпЖро╡рпНро╡ро╛ропрпН'},
      {name:'родро┐ро░рпБро╡ро╛родро┐ро░рпИ',lord:'ро░ро╛роХрпБ'},
      {name:'рокрпБройро░рпНрокрпВроЪроорпН',lord:'роХрпБро░рпБ'},
      {name:'рокрпВроЪроорпН',lord:'роЪройро┐'},
      {name:'роЖропро┐ро▓рпНропроорпН',lord:'рокрпБродройрпН'},
      {name:'роороХроорпН',lord:'роХрпЗродрпБ'},
      {name:'рокрпВро░роорпН',lord:'роЪрпБроХрпНро░ройрпН'},
      {name:'роЙродрпНродро┐ро░роорпН',lord:'роЪрпВро░ро┐ропройрпН'},
      {name:'ро╣ро╕рпНродроорпН',lord:'роЪроирпНродро┐ро░ройрпН'},
      {name:'роЪро┐родрпНродро┐ро░рпИ',lord:'роЪрпЖро╡рпНро╡ро╛ропрпН'},
      {name:'роЪрпБро╡ро╛родро┐',lord:'ро░ро╛роХрпБ'},
      {name:'ро╡ро┐роЪро╛роХроорпН',lord:'роХрпБро░рпБ'},
      {name:'роЕройрпБро╖роорпН',lord:'роЪройро┐'},
      {name:'роХрпЗроЯрпНроЯрпИ',lord:'рокрпБродройрпН'},
      {name:'роорпВро▓роорпН',lord:'роХрпЗродрпБ'},
      {name:'рокрпВро░ро╛роЯроорпН',lord:'роЪрпБроХрпНро░ройрпН'},
      {name:'роЙродрпНродро┐ро░ро╛роЯроорпН',lord:'роЪрпВро░ро┐ропройрпН'},
      {name:'родро┐ро░рпБро╡рпЛрогроорпН',lord:'роЪроирпНродро┐ро░ройрпН'},
      {name:'роЕро╡ро┐роЯрпНроЯроорпН',lord:'роЪрпЖро╡рпНро╡ро╛ропрпН'},
      {name:'роЪродропроорпН',lord:'ро░ро╛роХрпБ'},
      {name:'рокрпВро░роЯрпНроЯро╛родро┐',lord:'роХрпБро░рпБ'},
      {name:'роЙродрпНродро┐ро░роЯрпНроЯро╛родро┐',lord:'роЪройро┐'},
      {name:'ро░рпЗро╡родро┐',lord:'рокрпБродройрпН'}
    ];
    function addYears(date, years) {
      let d = new Date(date), y = Math.floor(years), m = (years - y) * 12;
      d.setFullYear(d.getFullYear() + y);
      d.setMonth(d.getMonth() + Math.floor(m));
      d.setDate(d.getDate() + Math.round((m - Math.floor(m)) * 30));
      return d;
    }
    function formatDate(dt) { return dt.toISOString().slice(0,10); }
    function cycle9Nakshatras(start) { return Array(9).fill(0).map((_,j) => (start+j)%27); }

    // --- CORRECT MAHADASHA: always start from Moon's nakshatra lord ---
    function getDasaLordsAndNames(moon) {
      const nakLen = 13 + 20/60; // 13┬░20'
      const nakIdx = Math.floor(moon / nakLen);
      const startLord = NAKS[nakIdx].lord;
      const planetOrder = PLANETS;
      const startIdx = planetOrder.indexOf(startLord);
      const dasaLords = planetOrder.slice(startIdx).concat(planetOrder.slice(0,startIdx));
      const dasaNakIdxs = Array(9).fill(0).map((_,j) => (nakIdx + j) % 27);
      const dasaNakNames = dasaNakIdxs.map(idx => NAKS[idx].name);
      return {dasaLords, dasaNakIdxs, dasaNakNames, nakIdx};
    }


    function dasaTree(moon, dob, now) {
      const nakLen = 13 + 20/60;
      const {dasaLords, dasaNakIdxs, dasaNakNames, nakIdx} = getDasaLordsAndNames(moon);
      const offsetDeg = moon - nakIdx * nakLen;
      let balance = 1 - (offsetDeg / nakLen);
      let mdStarts = [], cursor = addYears(dob, -(DASA_YEARS[dasaLords[0]] * (1 - balance)));
      for(let i=0; i<9; i++) {
        mdStarts[i] = new Date(cursor);
        let span = DASA_YEARS[dasaLords[i]];
        cursor = addYears(cursor, span);
      }
      let arr = dasaLords.map((lord,i) => ({
        index: i,
        lord: lord,
        nak: dasaNakNames[i],
        nakIdx: dasaNakIdxs[i],
        start: mdStarts[i],
        end: mdStarts[i+1] || cursor,
        current: now >= mdStarts[i] && now < (mdStarts[i+1]||cursor),
        puthis: []
      }));
      arr.forEach((md, mdi) => {
        let puthiNakIdxs = cycle9Nakshatras(md.nakIdx);
        let puthiLords = puthiNakIdxs.map(idx => NAKS[idx].lord);
        let puthiNakNames = puthiNakIdxs.map(idx => NAKS[idx].name);
        let duration = (md.end - md.start) / (1000*60*60*24*365.2425);
        let antarStarts = [], cursorP = new Date(md.start);
        for(let j=0; j<9; j++) {
          antarStarts[j] = new Date(cursorP);
          let antardur = duration * (DASA_YEARS[puthiLords[j]] / 120);
          cursorP = addYears(cursorP, antardur);
        }
        md.puthis = puthiLords.map((plord,pi) => ({
          index: pi,
          lord: plord,
          nak: puthiNakNames[pi],
          nakIdx: puthiNakIdxs[pi],
          start: antarStarts[pi],
          end: antarStarts[pi+1] || cursorP,
          current: now >= antarStarts[pi] && now < (antarStarts[pi+1] || cursorP),
          antharas: []
        }));
        md.puthis.forEach((pt, pk) => {
          let anthNakIdxs = cycle9Nakshatras(pt.nakIdx);
          let anthLords = anthNakIdxs.map(idx => NAKS[idx].lord);
          let anthNakNames = anthNakIdxs.map(idx => NAKS[idx].name);
          let dur = (pt.end - pt.start) / (1000*60*60*24*365.2425);
          let anthStarts = [], cursorA = new Date(pt.start);
          for(let k=0; k<9; k++) {
            anthStarts[k] = new Date(cursorA);
            let ahDur = dur * (DASA_YEARS[anthLords[k]] / 120);
            cursorA = addYears(cursorA, ahDur);
          }
          pt.antharas = anthLords.map((alord, ai) => ({
            index: ai,
            lord: alord,
            nak: anthNakNames[ai],
            nakIdx: anthNakIdxs[ai],
            start: anthStarts[ai],
            end: anthStarts[ai+1] || cursorA,
            current: now >= anthStarts[ai] && now < (anthStarts[ai+1] || cursorA)
          }));
        });
      });
      return arr;
    }
    function currentPadaSplit(period) {
      if(!period) return [];
      let nakIdx = period.nakIdx;
      let cursor = new Date(period.start);
      let len = (period.end - period.start) / (1000*60*60*24*365.2425) / 4;
      let arr = [];
      for(let i=0; i<4; i++) {
        let padaEnd = addYears(cursor, len);
        arr.push({ nak: NAKS[nakIdx].name, pada: i+1, lord: NAKS[nakIdx].lord, start: new Date(cursor), end: padaEnd });
        cursor = padaEnd;
      }
      return arr;
    }
    function findCurrentPath(tree) {
      for(let i=0; i<tree.length; i++) {
        let md = tree[i];
        if(md.current) {
          let dI = i, pI = -1, aI = -1;
          for(let j=0; j<md.puthis.length; j++) {
            let pt = md.puthis[j];
            if(pt.current) {
              pI = j;
              for(let k=0; k<pt.antharas.length; k++) {
                if(pt.antharas[k].current) { aI = k; }
              }
            }
          }
          return { dasa: dI, puthi: pI, anth: aI };
        }
      }
      return { dasa:-1, puthi:-1, anth:-1 };
    }
    function getCurrentPada(period, now) {
      if(!period) return {padaIdx:-1, pada:null, from:null, to:null, nak:null};
      let cursor = new Date(period.start);
      let len = (period.end - period.start) / (1000*60*60*24*365.2425) / 4;
      for(let i=0; i<4; i++) {
        let padaEnd = addYears(cursor, len);
        if(now >= cursor && now < padaEnd) return {
          padaIdx: i,
          pada: i + 1,
          from: new Date(cursor),
          to: new Date(padaEnd),
          nak: NAKS[period.nakIdx].name
        };
        cursor = padaEnd;
      }
      return {padaIdx:-1,pada:null,nak:null};
    }
    // Tree expand/collapse state
    let openState = { dasa:null, puthi:null, anthara:null };


    function renderSummary(md, mdPada, pt, ptPada, at, atPada) {
      let html = `<div class="currentbox" style="margin-bottom:26px;text-align:left;">
        <div><span style="color:#1d60b2;font-weight:bold;">родроЪрпИ</span>: <b>${md.lord}</b> [${md.nak} - рокро╛родроорпН ${mdPada.pada||'-'}] <span class="dates">${mdPada.from ? formatDate(mdPada.from) + ' - ' + formatDate(mdPada.to) : ''}</span></div>
        <div><span style="color:#266bbc;font-weight:bold;">рокрпБроХрпНродро┐</span>: <b>${pt.lord}</b> [${pt.nak} - рокро╛родроорпН ${ptPada.pada||'-'}] <span class="dates">${ptPada.from ? formatDate(ptPada.from) + ' - ' + formatDate(ptPada.to) : ''}</span></div>
        <div><span style="color:#3aa9ff;font-weight:bold;">роЕроирпНродро░роорпН</span>: <b>${at.lord}</b> [${at.nak} - рокро╛родроорпН ${atPada.pada||'-'}] <span class="dates">${atPada.from ? formatDate(atPada.from) + ' - ' + formatDate(atPada.to) : ''}</span></div>
        </div>`;
      document.getElementById("current").innerHTML = html;
    }
    function renderTree(arr, curr, openState) {
      function dasaUl() {
        let html = "<ul class='treeul' style='margin-bottom:18px;font-size:110%'>";
        arr.forEach((md, mi) => {
          let cl = (curr.dasa === mi) ? " current-dasa" : '';
          html += `<li class="headli${cl}">`;
          html += `<span class='expcol ${openState.dasa === mi ? "open" : ""}' onclick='expandDasa(${mi});event.stopPropagation();'>${openState.dasa === mi ? "тЦ╝" : "тЦ║"}</span> ┬а<b>родроЪрпИ: ${md.lord}</b> <span class='pada' style="color:#224ca7;"></span> `;
          if(openState.dasa === mi) html += puthiUl(md, mi);
          html += "</li>";
        });
        html += "</ul>"; return html;
      }
      function puthiUl(md, mdi) {
        let html = "<ul style='margin-bottom:2.5px;'>";
        md.puthis.forEach((pt, pi) => {
          let pcl = (curr.dasa === mdi && curr.puthi === pi) ? " current-puthi" : '';
          html += `<li class="headli${pcl}">` +
            `<span class='expcol ${openState.puthi === pi ? "open" : ""}' onclick='expandPuthi(${pi});event.stopPropagation();'>${openState.puthi === pi ? "тЦ╝" : "тЦ║"}</span> ┬а<b>рокрпБроХрпНродро┐: ${pt.lord}</b> <span class="pada" style="color:#266bbc;"></span> `;
          if(openState.puthi === pi) html += antharaUl(pt, mdi, pi);
          html += "</li>";
        });
        html += "</ul>"; return html;
      }
      function antharaUl(pt, mdi, pi) {
        let html = "<ul>";
        pt.antharas.forEach((at, ai) => {
          let acl = (curr.dasa === mdi && curr.puthi === pi && curr.anth === ai) ? " current-anthara" : '';
          html += `<li class="${acl}" onclick='expandAnthara(${ai});event.stopPropagation();'> <b>роЕроирпНродро░роорпН:${at.lord}</b> <span class="pada" style="color:#3aa9ff;"></span> </li>`;
        });
        html += "</ul>"; return html;
      }
      document.getElementById('dasatree').innerHTML = dasaUl();
    }
    function renderPadaSplit(arr, lab) {
      document.getElementById("padasplit").innerHTML =
        '<div class="padasplit"><b>рокроЯро╛ рокро┐ро░ро┐рокрпНрокрпБ:</b><br>' + lab + arr.map(pd => `<div>${pd.nak} - рокро╛родроорпН ${pd.pada} ┬а<span class="dates">${formatDate(pd.start)} - ${formatDate(pd.end)}</span></div>`).join("") + '</div>';
    }

    // EXPAND HANDLERS
    window.expandDasa = function(idx) {
      openState.dasa = (openState.dasa === idx ? null : idx);
      openState.puthi = null;
      openState.anthara = null;
      renderAll();
    };
    window.expandPuthi = function(idx) {
      openState.puthi = (openState.puthi === idx ? null : idx);
      openState.anthara = null;
      renderAll();
    };
    window.expandAnthara = function(idx) {
      openState.anthara = (openState.anthara === idx ? null : idx);
      renderAll();
    };

    function renderAll(nowParam) {
      let now = nowParam || new Date();
      let md = vimData[vimCurrentPath.dasa], pt = md && md.puthis[vimCurrentPath.puthi], at = pt && pt.antharas[vimCurrentPath.anth];
      let mdPada = getCurrentPada(md, now), ptPada = getCurrentPada(pt, now), atPada = getCurrentPada(at, now);
      clearAllHighlights();
      if(mdPada.pada > 0) highlightPada(mdPada.nak + ' - рокро╛родроорпН ' + mdPada.pada, 'highlight-dasa');
      if(ptPada.pada > 0) highlightPada(ptPada.nak + ' - рокро╛родроорпН ' + ptPada.pada, 'highlight-puthi');
      if(atPada.pada > 0) highlightPada(atPada.nak + ' - рокро╛родроорпН ' + atPada.pada, 'highlight-anth');
      renderSummary(md, mdPada, pt, ptPada, at, atPada);
      renderTree(vimData, vimCurrentPath, openState);
      // Pada split panel
      let target, lab = "";
      if(openState.anthara != null) {
        target = vimData[openState.dasa].puthis[openState.puthi].antharas[openState.anthara];
        lab = `<u>роЕроирпНродро░роорпН (${target.nak} ${target.lord}):</u>`;
      }
      else if(openState.puthi != null) {
        target = vimData[openState.dasa].puthis[openState.puthi];
        lab = `<u>рокрпБроХрпНродро┐ (${target.nak} ${target.lord}):</u>`;
      }
      else if(openState.dasa != null) {
        target = vimData[openState.dasa];
        lab = `<u>родроЪрпИ (${target.nak} ${target.lord}):</u>`;
      }
      else target = null;
      let arr = target ? currentPadaSplit(target) : [];
      renderPadaSplit(arr, lab);
    }
    let vimData, vimCurrentPath;

    function run() {
      let dobStr = document.getElementById("dob").value;
      let mdeg = parseInt(document.getElementById("moon_deg").value) || 0;
      let mmin = parseInt(document.getElementById("moon_min").value) || 0;
      let msec = parseInt(document.getElementById("moon_sec").value) || 0;
      let moon = mdeg + mmin / 60 + msec / 3600;
      if(isNaN(moon) || moon < 0 || moon >= 360) {
        alert("роЪроирпНродро┐ро░ройрпН роирпАро│роорпН роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.");
        return;
      }
      let dob = new Date(dobStr);
      if(isNaN(dob.getTime())) {
        alert("рокро┐ро▒роирпНрод родрпЗродро┐ роЪро░ро┐рокро╛ро░рпНроХрпНроХро╡рпБроорпН.");
        return;
      }

      // Use user-input calculation date or current time
      let caldateStr = document.getElementById("caldate").value;
      let now = caldateStr ? new Date(caldateStr) : new Date();

      vimData = dasaTree(moon, dob, now);
      vimCurrentPath = findCurrentPath(vimData);
      drawChartGrid();
      openState = {dasa: vimCurrentPath.dasa, puthi: vimCurrentPath.puthi, anthara: vimCurrentPath.anth};
      renderAll(now);
    }

    // First chart load
    drawChartGrid();
  </script>
</body>
</html>
